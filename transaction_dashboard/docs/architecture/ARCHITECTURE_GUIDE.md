# üìÅ Arquitectura de Features - Gu√≠a de Estructura

## üéØ Prop√≥sito

Este documento define la estructura est√°ndar de carpetas para implementar nuevos casos de uso (features) en el proyecto Transaction Dashboard, garantizando consistencia entre frontend y backend.

---

## üèóÔ∏è Estructura General

### Backend Structure
```
backend/src/
‚îú‚îÄ‚îÄ controllers/          # Controladores por feature
‚îÇ   ‚îú‚îÄ‚îÄ [feature].controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ services/            # Servicios por feature
‚îÇ   ‚îú‚îÄ‚îÄ [feature].service.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ repositories/        # Repositorios por feature
‚îÇ   ‚îú‚îÄ‚îÄ [feature].repository.ts
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ routes/             # Rutas por feature
‚îÇ   ‚îú‚îÄ‚îÄ [feature].routes.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ shared/             # C√≥digo compartido entre features
‚îÇ   ‚îú‚îÄ‚îÄ shared.repository.ts
‚îÇ   ‚îî‚îÄ‚îÄ shared.service.ts
‚îú‚îÄ‚îÄ utils/              # Utilidades generales
‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îú‚îÄ‚îÄ config/             # Configuraciones
‚îú‚îÄ‚îÄ middleware/         # Middlewares globales
‚îî‚îÄ‚îÄ jobs/              # Tareas programadas
```

### Frontend Structure
```
frontend/src/
‚îú‚îÄ‚îÄ features/           # Features organizados por dominio
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/      # Dashboard principal
‚îÇ   ‚îú‚îÄ‚îÄ casos/          # Casos de uso de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [caso-uso]/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ shared/         # C√≥digo compartido entre features
‚îú‚îÄ‚îÄ components/         # Componentes UI globales reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ ui/            # Componentes base (Button, Card, etc)
‚îÇ   ‚îú‚îÄ‚îÄ layout/        # Componentes de layout
‚îÇ   ‚îú‚îÄ‚îÄ charts/        # Componentes de gr√°ficos
‚îÇ   ‚îî‚îÄ‚îÄ tables/        # Componentes de tablas
‚îú‚îÄ‚îÄ hooks/             # Hooks globales
‚îú‚îÄ‚îÄ services/          # Servicios API globales
‚îú‚îÄ‚îÄ stores/            # State management global
‚îú‚îÄ‚îÄ utils/             # Utilidades globales
‚îî‚îÄ‚îÄ styles/            # Estilos globales
```

---

## üì¶ Estructura Detallada de un Feature

### 1. Backend Feature Structure

```
backend/src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ [feature].controller.ts         # üéÆ Controlador del feature
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ [feature].service.ts            # üíº L√≥gica de negocio
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ [feature].repository.ts         # üóÑÔ∏è Acceso a datos
‚îî‚îÄ‚îÄ routes/
    ‚îî‚îÄ‚îÄ [feature].routes.ts             # üõ£Ô∏è Definici√≥n de rutas
```

#### Ejemplo: Feature "Dashboard"
```
backend/src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ dashboard.controller.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ dashboard.service.ts
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ dashboard.repository.ts
‚îî‚îÄ‚îÄ routes/
    ‚îî‚îÄ‚îÄ dashboard.routes.ts
```

#### Ejemplo: Feature "Caducidad" (Caso de Uso)
```
backend/src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ caducidad.controller.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ caducidad.service.ts
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ caducidad.repository.ts
‚îî‚îÄ‚îÄ routes/
    ‚îî‚îÄ‚îÄ caducidad.routes.ts
```

### 2. Frontend Feature Structure

```
frontend/src/features/[feature]/
‚îú‚îÄ‚îÄ components/              # üß© Componentes espec√≠ficos del feature
‚îÇ   ‚îú‚îÄ‚îÄ [Component1].tsx
‚îÇ   ‚îú‚îÄ‚îÄ [Component2].tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # Barrel export
‚îú‚îÄ‚îÄ hooks/                  # ü™ù Custom hooks del feature
‚îÇ   ‚îú‚îÄ‚îÄ use[Feature]Data.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ pages/                  # üìÑ P√°ginas del feature
‚îÇ   ‚îî‚îÄ‚îÄ [Feature]Page.tsx
‚îú‚îÄ‚îÄ types.ts               # üìù Tipos TypeScript del feature
‚îî‚îÄ‚îÄ index.ts               # üì¶ Barrel export principal
```

#### Ejemplo Completo: Feature "Dashboard"
```
frontend/src/features/dashboard/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ DashboardStats.tsx
‚îÇ   ‚îú‚îÄ‚îÄ QuickActions.tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useDashboardMetrics.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ DashboardHomePage.tsx
‚îú‚îÄ‚îÄ types.ts
‚îî‚îÄ‚îÄ index.ts
```

#### Ejemplo Completo: Caso de Uso "Horarios"
```
frontend/src/features/casos/horarios/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ HorariosChart.tsx
‚îÇ   ‚îú‚îÄ‚îÄ HorariosMetrics.tsx
‚îÇ   ‚îú‚îÄ‚îÄ HorariosTable.tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useHorariosData.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ HorariosPage.tsx
‚îú‚îÄ‚îÄ types.ts
‚îî‚îÄ‚îÄ index.ts
```

#### Ejemplo Completo: Caso de Uso "Caducidad"
```
frontend/src/features/casos/caducidad/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ CaducidadBarChart.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CaducidadMetrics.tsx
‚îÇ   ‚îú‚îÄ‚îÄ CriticalProductsTable.tsx
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useCaducidadData.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îî‚îÄ‚îÄ CaducidadPage.tsx
‚îú‚îÄ‚îÄ types.ts
‚îî‚îÄ‚îÄ index.ts
```

---

## üîß Convenciones de Nomenclatura

### Backend

| Tipo | Patr√≥n | Ejemplo |
|------|--------|---------|
| Controller | `[feature].controller.ts` | `dashboard.controller.ts` |
| Service | `[feature].service.ts` | `horarios.service.ts` |
| Repository | `[feature].repository.ts` | `caducidad.repository.ts` |
| Routes | `[feature].routes.ts` | `precios.routes.ts` |

### Frontend

| Tipo | Patr√≥n | Ejemplo |
|------|--------|---------|
| Feature Folder | `[feature]/` o `casos/[caso-uso]/` | `dashboard/`, `casos/horarios/` |
| Component | `[Feature][Component].tsx` | `HorariosChart.tsx` |
| Hook | `use[Feature][Action].ts` | `useHorariosData.ts` |
| Page | `[Feature]Page.tsx` | `CaducidadPage.tsx` |
| Types | `types.ts` | `types.ts` |
| Barrel Export | `index.ts` | `index.ts` |

---

## üìù Contenido de Archivos Clave

### 1. Backend Controller Template

```typescript
// backend/src/controllers/[feature].controller.ts
import { Request, Response } from 'express'
import { logger } from '../utils/logger'
import { [feature]Service } from '../services/[feature].service'

class [Feature]Controller {
  // Test endpoint
  testEndpoint = async (_req: Request, res: Response) => {
    try {
      logger.info('üß™ [Feature] test endpoint called')
      
      res.status(200).json({
        success: true,
        message: 'üéâ [Feature] API funcionando correctamente!',
        timestamp: new Date().toISOString()
      })
    } catch (error) {
      logger.error('‚ùå [Feature] test endpoint error:', error)
      res.status(500).json({
        success: false,
        error: 'Error en endpoint de prueba'
      })
    }
  }

  // Implementar m√©todos espec√≠ficos del feature aqu√≠
}

export const [feature]Controller = new [Feature]Controller()
```

### 2. Backend Service Template

```typescript
// backend/src/services/[feature].service.ts
import { SharedService } from '../shared/shared.service'
import { [feature]Repository } from '../repositories/[feature].repository'

export class [Feature]Service extends SharedService {
  constructor() {
    super()
    this.logger.info('[Feature]Service initialized')
  }

  // Implementar m√©todos de l√≥gica de negocio aqu√≠
}

export const [feature]Service = new [Feature]Service()
```

### 3. Backend Repository Template

```typescript
// backend/src/repositories/[feature].repository.ts
import { SharedRepository } from '../shared/shared.repository'

export class [Feature]Repository extends SharedRepository {
  
  // Implementar queries espec√≠ficas aqu√≠
  
  async testConnection() {
    try {
      const result = await this.prisma.$queryRaw`SELECT NOW() as now`
      return {
        message: '[Feature] repository connection OK',
        timestamp: result[0].now
      }
    } catch (error) {
      console.error('Error in testConnection:', error)
      throw new Error('Database connection failed')
    }
  }
}

export const [feature]Repository = new [Feature]Repository()
```

### 4. Backend Routes Template

```typescript
// backend/src/routes/[feature].routes.ts
import { Router } from 'express'
import { [feature]Controller } from '../controllers/[feature].controller'

const [feature]Routes = Router()

// Test route
[feature]Routes.get('/test', [feature]Controller.testEndpoint)

// Implementar rutas espec√≠ficas aqu√≠

export { [feature]Routes }
```

### 5. Frontend types.ts Template

```typescript
// frontend/src/features/[feature]/types.ts

export interface [Feature]Data {
  // Definir tipos de datos aqu√≠
}

export interface [Feature]Metrics {
  // Definir tipos de m√©tricas aqu√≠
}

// Otros tipos necesarios...
```

### 6. Frontend Hook Template

```typescript
// frontend/src/features/[feature]/hooks/use[Feature]Data.ts
import { useQuery, UseQueryResult } from '@tanstack/react-query'
import apiClient from '../../../services/api/client'
import type { [Feature]Data } from '../types'

export const use[Feature]Data = (): UseQueryResult<[Feature]Data, Error> => {
  return useQuery({
    queryKey: ['[feature]', 'data'],
    queryFn: async (): Promise<[Feature]Data> => {
      const response = await apiClient.get('/casos/[feature]/data')
      if (!response.data.success) {
        throw new Error('Failed to fetch [feature] data')
      }
      return response.data.data
    },
    staleTime: 5 * 60 * 1000,
    gcTime: 10 * 60 * 1000,
    refetchOnWindowFocus: false,
  })
}
```

### 7. Frontend index.ts Template

```typescript
// frontend/src/features/[feature]/index.ts

// Pages
export { [Feature]Page } from './pages/[Feature]Page'

// Components
export * from './components'

// Hooks
export * from './hooks/use[Feature]Data'

// Types
export type * from './types'
```

### 8. Frontend Page Template

```typescript
// frontend/src/features/[feature]/pages/[Feature]Page.tsx
import React from 'react'
import { use[Feature]Data } from '../hooks/use[Feature]Data'
import { Card } from '../../../components/ui/Card'
import { Spinner } from '../../../components/ui/Spinner'

export const [Feature]Page: React.FC = () => {
  const { data, isLoading, isError } = use[Feature]Data()

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Spinner size="xl" />
      </div>
    )
  }

  if (isError) {
    return (
      <Card padding="lg">
        <div className="text-center">
          <div className="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 className="text-2xl font-bold text-gray-900">
            Error al cargar datos
          </h2>
        </div>
      </Card>
    )
  }

  return (
    <div className="space-y-8">
      <h1 className="text-3xl font-bold text-gray-900">
        [Feature Name]
      </h1>
      
      {/* Implementar contenido aqu√≠ */}
    </div>
  )
}
```

---

## üõ£Ô∏è Configuraci√≥n de Rutas

### Backend: routes/index.ts

```typescript
import { Router } from 'express'
import { [feature]Routes } from './[feature].routes'

const router = Router()

const apiPrefix = process.env.API_PREFIX || '/api'
const apiVersion = process.env.API_VERSION || 'v1'

// Feature routes
router.use(`${apiPrefix}/${apiVersion}/[feature]`, [feature]Routes)

// Para casos de uso
router.use(`${apiPrefix}/${apiVersion}/casos/[caso-uso]`, [casoUso]Routes)

export { router }
```

### Frontend: router.tsx

```typescript
import { createBrowserRouter } from 'react-router-dom'
import { MainLayout } from './components/layout/MainLayout'
import { [Feature]Page } from './features/[feature]'

export const router = createBrowserRouter([
  {
    path: '/',
    element: <MainLayout />,
    children: [
      // Feature routes
      {
        path: '[feature]',
        element: <[Feature]Page />,
      },
      // Casos de uso routes
      {
        path: 'casos/[caso-uso]',
        element: <[CasoUso]Page />,
      },
    ],
  },
])
```

---

## ‚úÖ Checklist para Nuevo Feature

### Backend

- [ ] Crear `[feature].controller.ts` con m√©todos necesarios
- [ ] Crear `[feature].service.ts` con l√≥gica de negocio
- [ ] Crear `[feature].repository.ts` con queries
- [ ] Crear `[feature].routes.ts` con definici√≥n de rutas
- [ ] Registrar rutas en `routes/index.ts`
- [ ] Agregar test endpoint para verificar conectividad
- [ ] Implementar manejo de errores consistente
- [ ] Agregar logging apropiado

### Frontend

- [ ] Crear carpeta `features/[feature]/` o `features/casos/[caso-uso]/`
- [ ] Crear subcarpetas: `components/`, `hooks/`, `pages/`
- [ ] Crear `types.ts` con todas las interfaces necesarias
- [ ] Crear hooks personalizados en `hooks/`
- [ ] Crear componentes espec√≠ficos en `components/`
- [ ] Crear p√°gina principal en `pages/[Feature]Page.tsx`
- [ ] Crear `index.ts` para barrel exports
- [ ] Registrar ruta en `router.tsx`
- [ ] Agregar link de navegaci√≥n en sidebar si aplica
- [ ] Implementar loading y error states
- [ ] Usar componentes UI consistentes

---

## üé® Casos de Uso Implementados

### ‚úÖ Dashboard (Completado)
```
Backend:  src/controllers/dashboard.controller.ts
          src/services/dashboard.service.ts
          src/repositories/dashboard.repository.ts
          src/routes/dashboard.routes.ts

Frontend: src/features/dashboard/
          ‚îú‚îÄ‚îÄ components/
          ‚îú‚îÄ‚îÄ hooks/
          ‚îú‚îÄ‚îÄ pages/DashboardHomePage.tsx
          ‚îú‚îÄ‚îÄ types.ts
          ‚îî‚îÄ‚îÄ index.ts

Ruta:     /
API:      /api/v1/dashboard/*
```

### ‚úÖ Caso 1: Patrones Horarios (Completado)
```
Backend:  src/controllers/horarios.controller.ts
          src/services/horarios.service.ts
          src/repositories/horarios.repository.ts
          src/routes/horarios.routes.ts

Frontend: src/features/casos/horarios/
          ‚îú‚îÄ‚îÄ components/
          ‚îÇ   ‚îú‚îÄ‚îÄ HorariosChart.tsx
          ‚îÇ   ‚îú‚îÄ‚îÄ HorariosMetrics.tsx
          ‚îÇ   ‚îî‚îÄ‚îÄ HorariosTable.tsx
          ‚îú‚îÄ‚îÄ hooks/
          ‚îÇ   ‚îî‚îÄ‚îÄ useHorariosData.ts
          ‚îú‚îÄ‚îÄ pages/
          ‚îÇ   ‚îî‚îÄ‚îÄ HorariosPage.tsx
          ‚îú‚îÄ‚îÄ types.ts
          ‚îî‚îÄ‚îÄ index.ts

Ruta:     /casos/horarios
API:      /api/v1/casos/horarios/*
ROI:      $6.7M
```

### üü° Caso 2: Control de Caducidad (En Progreso)
```
Backend:  src/controllers/caducidad.controller.ts
          src/services/caducidad.service.ts
          src/repositories/caducidad.repository.ts
          src/routes/caducidad.routes.ts

Frontend: src/features/casos/caducidad/
          ‚îú‚îÄ‚îÄ components/
          ‚îÇ   ‚îú‚îÄ‚îÄ CaducidadBarChart.tsx
          ‚îÇ   ‚îú‚îÄ‚îÄ CaducidadMetrics.tsx
          ‚îÇ   ‚îî‚îÄ‚îÄ CriticalProductsTable.tsx
          ‚îú‚îÄ‚îÄ hooks/
          ‚îÇ   ‚îî‚îÄ‚îÄ useCaducidadData.ts
          ‚îú‚îÄ‚îÄ pages/
          ‚îÇ   ‚îî‚îÄ‚îÄ CaducidadPage.tsx
          ‚îú‚îÄ‚îÄ types.ts
          ‚îî‚îÄ‚îÄ index.ts

Ruta:     /casos/caducidad
API:      /api/v1/casos/caducidad/*
ROI:      $2.1M - $3.8M
```

---

## üöÄ Casos de Uso Futuros (Plantilla)

### Caso 3: Gesti√≥n de Precios
```
Backend:  src/controllers/precios.controller.ts
          src/services/precios.service.ts
          src/repositories/precios.repository.ts
          src/routes/precios.routes.ts

Frontend: src/features/casos/precios/
          ‚îú‚îÄ‚îÄ components/
          ‚îú‚îÄ‚îÄ hooks/
          ‚îú‚îÄ‚îÄ pages/PreciosPage.tsx
          ‚îú‚îÄ‚îÄ types.ts
          ‚îî‚îÄ‚îÄ index.ts

Ruta:     /casos/precios
API:      /api/v1/casos/precios/*
ROI:      $150M
```

### Caso 4: Identificaci√≥n de Clientes
```
Backend:  src/controllers/clientes.controller.ts
Frontend: src/features/casos/clientes/
Ruta:     /casos/clientes
API:      /api/v1/casos/clientes/*
ROI:      $1.35B
```

### Caso 5: Seguimiento de Inventario
```
Backend:  src/controllers/inventario.controller.ts
Frontend: src/features/casos/inventario/
Ruta:     /casos/inventario
API:      /api/v1/casos/inventario/*
ROI:      $56.3M
```

### Caso 6: M√©todos de Pago
```
Backend:  src/controllers/pagos.controller.ts
Frontend: src/features/casos/pagos/
Ruta:     /casos/pagos
API:      /api/v1/casos/pagos/*
ROI:      Control de Riesgos
```

### Caso 7: Control de Devoluciones
```
Backend:  src/controllers/devoluciones.controller.ts
Frontend: src/features/casos/devoluciones/
Ruta:     /casos/devoluciones
API:      /api/v1/casos/devoluciones/*
ROI:      $1.13B
```

---

## üí° Mejores Pr√°cticas

### General
1. ‚úÖ Mantener consistencia entre backend y frontend
2. ‚úÖ Usar nombres descriptivos y en espa√±ol para features de negocio
3. ‚úÖ Cada feature debe ser autocontenido
4. ‚úÖ Compartir c√≥digo com√∫n en `shared/`
5. ‚úÖ Documentar cambios en archivos MD

### Backend
1. ‚úÖ Heredar de `SharedRepository` y `SharedService`
2. ‚úÖ Usar logger para todas las operaciones importantes
3. ‚úÖ Implementar manejo de errores consistente
4. ‚úÖ Incluir endpoint de test en cada feature
5. ‚úÖ Exportar instancias singleton

### Frontend
1. ‚úÖ Usar TanStack Query para data fetching
2. ‚úÖ Implementar loading y error states
3. ‚úÖ Componentes reutilizables en `/components/`
4. ‚úÖ Componentes espec√≠ficos en `features/[feature]/components/`
5. ‚úÖ Barrel exports con `index.ts`
6. ‚úÖ Tipos TypeScript centralizados en `types.ts`

---

## üìö Referencias

- **Arquitectura Backend**: `backend/src/`
- **Arquitectura Frontend**: `frontend/src/features/`
- **Documentaci√≥n de Refactorizaci√≥n**: `frontend/REFACTORING_DASHBOARD.md`
- **Documentaci√≥n de Limpieza**: `frontend/CLEANUP_PAGES.md`
- **An√°lisis Completo**: `frontend/ANALYSIS_COMPLETE.md`

---

**√öltima actualizaci√≥n:** 4 de octubre, 2025  
**Mantenido por:** Equipo de Desarrollo  
**Versi√≥n:** 1.0.0
