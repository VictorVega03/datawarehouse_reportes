# ๐๏ธ ARQUITECTURA DEL BACKEND - Diagrama Visual

## ๐ Estructura de Capas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CLIENT (Frontend)                        โ
โ                     React + TypeScript + Vite                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ HTTP REST API
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ๐ API GATEWAY LAYER                        โ
โ                    routes/index.ts (Router)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  /api/v1/casos/horarios/*      โ ACTIVO                        โ
โ  /api/v1/casos/caducidad/*     โณ PREPARADO                     โ
โ  /api/v1/casos/precios/*       โธ๏ธ FUTURO                        โ
โ  /api/v1/casos/clientes/*      โธ๏ธ FUTURO                        โ
โ  /api/v1/casos/inventario/*    โธ๏ธ FUTURO                        โ
โ  /api/v1/casos/pagos/*         โธ๏ธ FUTURO                        โ
โ  /api/v1/casos/devoluciones/*  โธ๏ธ FUTURO                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               ๐ฏ FEATURES LAYER (Casos de Uso)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  ๐ฆ features/shared/  (Cรณdigo Compartido)                โ  โ
โ  โ  โโ SharedRepository (Base para todos los repos)         โ  โ
โ  โ  โโ SharedService (Base para todos los services)         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  โ features/casos/horarios/ (Patrones Horarios)         โ  โ
โ  โ                                                           โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโ                 โ  โ
โ  โ  โ   Controller   โ  โ    Service     โ                 โ  โ
โ  โ  โ    (HTTP)      โโโถโ  (Business)    โ                 โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโฌโโโโโโโโโ                 โ  โ
โ  โ         โฒ                    โ                           โ  โ
โ  โ         โ                    โผ                           โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโ                 โ  โ
โ  โ  โ     Routes     โ  โ  Repository    โ                 โ  โ
โ  โ  โ   (Endpoints)  โ  โ   (Data)       โ                 โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโ                 โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  โณ features/casos/caducidad/ (Control Caducidad)        โ  โ
โ  โ  โโ caducidad.controller.ts  (โณ Preparado)              โ  โ
โ  โ  โโ caducidad.service.ts     (โณ Preparado)              โ  โ
โ  โ  โโ caducidad.repository.ts  (โณ Preparado)              โ  โ
โ  โ  โโ caducidad.routes.ts      (โณ Preparado)              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  โธ๏ธ features/casos/[otros]/ (Futuros)                    โ  โ
โ  โ  precios, clientes, inventario, pagos, devoluciones      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐พ DATA ACCESS LAYER                          โ
โ                        Prisma Client                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      ๐๏ธ DATABASE LAYER                          โ
โ                      PostgreSQL 14+                              โ
โ                   (transactions, inventory)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo de Datos (Ejemplo: GET /api/v1/casos/horarios/analysis)

```
1. ๐ฅ CLIENT REQUEST
   โ
   GET /api/v1/casos/horarios/analysis
   
2. ๐ช ROUTER (routes/index.ts)
   โ
   router.use('/api/v1/casos/horarios', horariosRoutes)
   
3. ๐ฃ๏ธ ROUTES (horarios.routes.ts)
   โ
   horariosRoutes.get('/analysis', horariosController.getHourlyAnalysis)
   
4. ๐ฎ CONTROLLER (horarios.controller.ts)
   โ
   horariosController.getHourlyAnalysis()
   โโ Valida request
   โโ Llama al service
   โโ Formatea response HTTP
   
5. ๐ผ SERVICE (horarios.service.ts)
   โ
   horariosService.getHourlyAnalysis()
   โโ Obtiene datos del repository
   โโ Aplica lรณgica de negocio
   โโ Calcula mรฉtricas (pico, valle, ROI)
   โโ Genera insights y recomendaciones
   
6. ๐๏ธ REPOSITORY (horarios.repository.ts)
   โ
   horariosRepository.getHourlyDistribution()
   โโ Query SQL via Prisma
   โโ Extrae hora de timestamp
   โโ Agrupa por hora
   โโ Retorna datos formateados
   
7. ๐พ PRISMA CLIENT
   โ
   await prisma.$queryRaw`SELECT ...`
   
8. ๐๏ธ POSTGRESQL
   โ
   Ejecuta query y retorna resultados
   
9. ๐ค RESPONSE FLOW (Inverso)
   โ
   Database โ Prisma โ Repository โ Service โ Controller โ Router โ Client
   
10. โ CLIENT RECEIVES
    {
      success: true,
      data: {
        peakHour: "14:00",
        peakTransactions: 125000,
        hourlyDistribution: [...],
        insights: [...],
        recommendations: [...]
      }
    }
```

---

## ๐๏ธ Patrรณn de Arquitectura por Caso de Uso

Cada caso de uso sigue este patrรณn estรกndar:

```
features/casos/{caso}/
โ
โโ {caso}.routes.ts          ๐ฃ๏ธ CAPA DE RUTAS
โ  โ  Define endpoints REST
โ  โ  Asocia rutas con controllers
โ  โโ Express Router
โ
โโ {caso}.controller.ts      ๐ฎ CAPA DE CONTROL
โ  โ  Maneja HTTP requests/responses
โ  โ  Validaciรณn de inputs
โ  โ  Logging de operaciones
โ  โโ Llama a services
โ
โโ {caso}.service.ts         ๐ผ CAPA DE NEGOCIO
โ  โ  Lรณgica de negocio
โ  โ  Procesamiento de datos
โ  โ  Cรกlculos y transformaciones
โ  โ  Generaciรณn de insights
โ  โโ Llama a repositories
โ
โโ {caso}.repository.ts      ๐๏ธ CAPA DE DATOS
   โ  Queries SQL (Prisma)
   โ  Acceso a base de datos
   โ  Formateo de datos raw
   โโ Retorna datos estructurados
```

---

## ๐ Herencia y Composiciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ       SharedRepository (Base)              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  - prisma: PrismaClient              โ โ
โ  โ  + checkDatabaseHealth()             โ โ
โ  โ  + getDateRange()                    โ โ
โ  โ  + getDashboardMetrics()             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ extends
                โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                โผ                      โผ               โผ
    โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ
    โHorariosRepository  โ  โCaducidadRepo...  โ  โ[Otros]     โ
    โ+ getHourlyDist..() โ  โ+ getExpiring...()โ  โ            โ
    โ+ getWeekdayDist...โ  โ+ getCaducidad...()โ  โ            โ
    โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ
```

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         SharedService (Base)               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  - logger: Logger                    โ โ
โ  โ  # formatNumber()                    โ โ
โ  โ  # calculateDailyAverage()           โ โ
โ  โ  # handleError()                     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ extends
                โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                โผ                      โผ               โผ
    โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ
    โ HorariosService    โ  โ CaducidadService โ  โ [Otros]    โ
    โ + getMetrics()     โ  โ + getMetrics()   โ  โ            โ
    โ + getAnalysis()    โ  โ + getAnalysis()  โ  โ            โ
    โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโ
```

---

## ๐ Comparaciรณn: Antes vs Despuรฉs

### โ ANTES (Monolรญtico)
```
src/
โโโ controllers/
โ   โโโ dashboard.controller.ts  (TODO junto aquรญ)
โโโ services/
โ   โโโ dashboard.service.ts     (TODO junto aquรญ)
โโโ repositories/
โ   โโโ dashboard.repository.ts  (TODO junto aquรญ)
โโโ routes/
    โโโ api/
        โโโ dashboard.routes.ts  (TODO junto aquรญ)

โ Problemas:
- No escalable
- Difรญcil de mantener
- Cรณdigo acoplado
- Testing complicado
```

### โ DESPUรS (Modular)
```
src/
โโโ features/
โ   โโโ shared/              (Cรณdigo reutilizable)
โ   โ   โโโ shared.repository.ts
โ   โ   โโโ shared.service.ts
โ   โ
โ   โโโ casos/               (Casos de uso separados)
โ       โโโ horarios/        โ Independiente
โ       โโโ caducidad/       โ Independiente
โ       โโโ precios/         โ Independiente
โ       โโโ [otros]/         โ Independiente
โ
โโโ routes/
    โโโ index.ts             (Router central)

โ Ventajas:
- Escalable
- Fรกcil de mantener
- Cรณdigo desacoplado
- Testing sencillo
- Separaciรณn clara de concerns
```

---

## ๐ฏ Principios SOLID Aplicados

### โ Single Responsibility Principle (SRP)
- Cada clase tiene UNA responsabilidad
- Repository โ Data Access
- Service โ Business Logic
- Controller โ HTTP Handling

### โ Open/Closed Principle (OCP)
- Clases base (Shared) abiertas para extensiรณn
- Cerradas para modificaciรณn
- Nuevos casos extienden sin modificar base

### โ Liskov Substitution Principle (LSP)
- Cualquier Repository puede usarse donde se espera SharedRepository
- Misma interface, diferente implementaciรณn

### โ Interface Segregation Principle (ISP)
- Interfaces pequeรฑas y especรญficas
- Cada caso implementa solo lo que necesita

### โ Dependency Inversion Principle (DIP)
- Controller depende de Service (abstracciรณn)
- Service depende de Repository (abstracciรณn)
- No dependencias directas a implementaciones concretas

---

## ๐ Escalabilidad

### Aรฑadir nuevo caso de uso (3 pasos):

```bash
1. Copiar template de caso existente
   cp -r features/casos/caducidad features/casos/nuevo_caso

2. Renombrar archivos y clases
   nuevo_caso.repository.ts
   nuevo_caso.service.ts
   nuevo_caso.controller.ts
   nuevo_caso.routes.ts

3. Registrar en routes/index.ts
   import { nuevoCasoRoutes } from '../features/casos/nuevo_caso/...'
   router.use('/api/v1/casos/nuevo_caso', nuevoCasoRoutes)
```

**Tiempo estimado:** 15-30 minutos para estructura base

---

## ๐ Seguridad y Middleware

```
Request โ Middleware Chain โ Controller โ Service โ Repository
          โ
          โโ CORS
          โโ Body Parser
          โโ Auth (JWT)
          โโ Rate Limiting
          โโ Validation
          โโ Logging
```

---

**Documentaciรณn completa:** `backend/REFACTORING.md`  
**Fecha de actualizaciรณn:** October 3, 2025
